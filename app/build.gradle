apply plugin: 'com.android.application'

android {
    namespace 'com.wzy.nesteddetail'
    compileSdkVersion 34
    
    defaultConfig {
        applicationId "com.wzy.nesteddetail"
        minSdkVersion 21
        targetSdkVersion 34
        versionCode 1
        versionName "1.0"
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}

// è‡ªå®šä¹‰ä»»åŠ¡ï¼šæ£€æŸ¥XMLæ–‡ä»¶ä¸­çš„éandroidxå¼•ç”¨
task checkXmlReferences {
    description = 'æ£€æŸ¥XMLæ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨éandroidxå¼•ç”¨'
    group = 'verification'
    
    doLast {
        def resDir = file('src/main/res')
        def hasErrors = false
        def errorFiles = []
        
        println "ğŸ” å¼€å§‹æ£€æŸ¥XMLæ–‡ä»¶ä¸­çš„éandroidxå¼•ç”¨..."
        
        resDir.eachFileRecurse { file ->
            if (file.name.endsWith('.xml')) {
                def content = file.text
                if (content.contains('android.support.')) {
                    def relativePath = file.relativePath(resDir)
                    println "âŒ å‘ç°éandroidxå¼•ç”¨: ${relativePath}"
                    
                    // æŸ¥æ‰¾å…·ä½“çš„å¼•ç”¨
                    content.eachLine { line, lineNumber ->
                        if (line.contains('android.support.')) {
                            def matches = line.findAll(/android\.support\.[\w.]+/)
                            matches.each { match ->
                                println "   ç¬¬${lineNumber}è¡Œ: ${match}"
                                errorFiles << "${relativePath}:${lineNumber} - ${match}"
                            }
                        }
                    }
                    hasErrors = true
                }
            }
        }
        
        if (hasErrors) {
            println "\nğŸ’¥ æ„å»ºå¤±è´¥ï¼šå‘ç°${errorFiles.size()}ä¸ªéandroidxå¼•ç”¨"
            println "è¯·å°†ä»¥ä¸‹å¼•ç”¨æ›¿æ¢ä¸ºandroidxç‰ˆæœ¬ï¼š"
            errorFiles.each { error ->
                println "   - ${error}"
            }
            println "\nå»ºè®®æ›¿æ¢ï¼š"
            println "   android.support.constraint.ConstraintLayout â†’ androidx.constraintlayout.widget.ConstraintLayout"
            println "   android.support.v7.widget.RecyclerView â†’ androidx.recyclerview.widget.RecyclerView"
            println "   android.support.v4.* â†’ androidx.legacy.* æˆ–å¯¹åº”çš„androidxåŒ…"
            throw new GradleException("XMLéªŒè¯å¤±è´¥ï¼šå‘ç°éandroidxå¼•ç”¨ï¼Œæ„å»ºç»ˆæ­¢")
        } else {
            println "âœ… æ‰€æœ‰XMLæ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼Œæœªå‘ç°éandroidxå¼•ç”¨"
        }
    }
}

// å°†æ£€æŸ¥ä»»åŠ¡å…³è”åˆ°ç¼–è¯‘æµç¨‹
preBuild.dependsOn checkXmlReferences

// ä¹Ÿå¯ä»¥åœ¨cleanåæ‰§è¡Œæ£€æŸ¥
clean.finalizedBy checkXmlReferences

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation 'androidx.appcompat:appcompat:1.4.2'
    implementation 'androidx.legacy:legacy-support-v4:1.0.0'
    implementation 'androidx.recyclerview:recyclerview:1.2.1'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
}
